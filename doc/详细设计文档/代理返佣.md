# 代理返佣模块实现

## 1 代理注册

```mermaid
sequenceDiagram
    participant operator
    participant user
    participant otc_admin
    participant otc
    operator->>otc_admin:注册一级代理手机号
    otc_admin->>otc_admin:存储一级代理手机号
    user->>otc:登录
    otc->>otc:是否是一级代理?
    Note right of otc: 非一级代理登录时未提供<br>邀请码直接拒绝。
    otc->>user:拒绝登录
    Note right of otc: 一级代理登录跳过邀请码<br>校验
    otc->>otc:生成代理层级关系
```
<center>代理注册时序图</center>

```mermaid
  graph TD;
    1级代理.00010001-->2级代理A.00010001.00020001;
    1级代理.00010001-->2级代理B.00010001.00020002;
    1级代理.00010001-->2级代理C.00010001.00020003;
    2级代理A.00010001.00020001-->3级代理A.00010001.00020001.00030001;
    2级代理A.00010001.00020001-->3级代理A.00010001.00020001.00030002;
```

<center>代理层级关系树状图</center>

### 1.1 一级代理注册

一级代理通过后台系统注册，实际上只是手机号的注册，无复杂流程。

### 1.2 N级代理注册

非一级代理用户注册时必须指定邀请码才能注册，否则会直接被拒绝。

## 2 代理佣金

### 2.1 代理佣金结算

```mermaid
sequenceDiagram
    participant otc_admin
    participant otc
    otc_admin->>otc:启动结算
    otc->>otc_admin:返回
    otc->>game server:同步游戏用户日报
    otc->>otc:存储游戏用户日报数据
    otc->>otc:如果失败，记录结算状态及失败原因
    loop 每个代理用户
        otc->>otc:结算返佣
    end
    otc->>otc:如果失败，记录结算状态及失败原因
    otc->>game server:同步渠道流水日报
    game server->>otc:返回渠道流水日报
    otc->>otc:如果失败，记录结算状态及失败原因
    otc->>otc:扣除游戏提成
    otc->>otc:计算平台利润
    otc->>otc:记录结算统计信息，并且将结算状态标记为未发放
```
<center>代理佣金结算时序图</center>

```mermaid
graph TD
    A[开始]-->B(获取代理返佣等级参数)
    B --> C{是否配置了返佣等级参数}
    C -->|已配置| D[根据返佣等级参数结算返佣值]
    C -->|未配置| E[根据业绩值结算返佣值]
    D --> F[结束]
    E --> F[结束]
```
<center>代理获取返佣指数流程图</center>

### 2.2 代理佣金发放

```mermaid
sequenceDiagram
    otc_admin->>otc:启动发放
    otc->>otc_admin:返回
    otc->>otc:创建发放日志
    otc->>otc:查询平台利润
    Note right of otc:平台利润小于等于0，暂停发放。
    otc->>otc:发放游戏渠道提成
    otc->>otc:发放平台利润
    loop 每个代理用户
        otc->>otc:发放佣金
        otc->>otc:更新代理发放状态为已发放
      end
    otc->>otc:更新发放状态为已发放
```

<center>代理佣金发放时序图</center>

## 3 后台相关

### 3.1 代理列表

| 代理ID | 上级代理ID | 档位ID | 邀请码 | 邀请人数 | 累计佣金 | 可提现余额 | 更新时间 | 操作 |
| ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |
| 169750614920658944 | 169750166759276544 | 0 | WWMB43 | 0 | 0.0000 | 0.0000 | 2019-04-14 18:08:20 | <删除> |

### 3.2 一级代理

| 手机号 | 状态 | 更新时间 | 操作 |
| ----- | ----- | ----- | ----- |
| 18665876646 | 已注册 | 2019-04-14 18:06:22 | <删除> |

### 3.3 档位列表

| 档位ID | 档位名称 | 佣金（元/万） | 更新时间 | 操作 |
| ----- | ----- | ----- | ----- | ----- |
| 1 | 黄金 | 120 | 2019-04-14 18:16:26 | <详情> <编辑> <删除> |

### 3.4 佣金等级

| 业绩开始金额(万) | 业绩结束金额(万) | 每万业绩佣金(元/万) | 操作 |
| ----- | ----- | ----- | ----- |
| 0 | 10 | 50 | <删除> |

### 3.5 佣金统计

| 日期 | 税收 | 渠道 | 佣金 | 利润 | 发放状态 | 操作 |
| ----- | ----- | ----- | ----- | ----- | ----- |
| 2019-04-14 | 63423.0000 | 1034.2250 | 336.0000 | 8972.0250 | 未发放 | <结算佣金> <发放佣金> |
